var Y=n=>{throw TypeError(n)};var F=(n,e,t)=>e.has(n)||Y("Cannot "+t);var y=(n,e,t)=>(F(n,e,"read from private field"),t?t.call(n):e.get(n)),P=(n,e,t)=>e.has(n)?Y("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),C=(n,e,t,i)=>(F(n,e,"write to private field"),i?i.call(n,t):e.set(n,t),t),X=(n,e,t)=>(F(n,e,"access private method"),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function t(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(r){if(r.ep)return;r.ep=!0;const s=t(r);fetch(r.href,s)}})();const le={BASE_URL:"https://story-api.dicoding.dev/v1",DATABASE_NAME:"story-app-database",DATABASE_VERSION:1,OBJECT_STORE_NAME:"stories"};class O{constructor(e=le.BASE_URL){this.baseUrl=e}async _request(e,t={}){const i=await fetch(`${this.baseUrl}${e}`,t);let r;try{r=await i.json()}catch{r=null}if(!i.ok){const s=(r==null?void 0:r.message)||`Request failed with status ${i.status}`,a=new Error(s);throw a.status=i.status,a.payload=r,a}return r}async signUp(e){return this._request("/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}async signIn(e){return this._request("/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}async listStories({token:e,page:t=1,size:i=10,location:r=0}={}){const s=new URLSearchParams;s.set("page",t),s.set("size",i),s.set("location",r);const a=e?{Authorization:`Bearer ${e}`}:{};return this._request(`/stories?${s.toString()}`,{headers:a})}async readStory(e,t){if(!e)throw new Error("Story id is required");const i=t?{Authorization:`Bearer ${t}`}:{};return this._request(`/stories/${e}`,{headers:i})}async createStory({authToken:e,text:t,file:i,lat:r,lon:s}){if(!e)throw new Error("authToken required to create story");const a=new FormData;return t!=null&&a.append("description",t),i&&a.append("photo",i),r!=null&&a.append("lat",String(r)),s!=null&&a.append("lon",String(s)),this._request("/stories",{method:"POST",headers:{Authorization:`Bearer ${e}`},body:a})}async createStoryGuest({text:e,file:t,lat:i,lon:r}){const s=new FormData;return e!=null&&s.append("description",e),t&&s.append("photo",t),i!=null&&s.append("lat",String(i)),r!=null&&s.append("lon",String(r)),this._request("/stories/guest",{method:"POST",body:s})}async subscribePush({authToken:e,subscription:t}){var r,s;if(!e)throw new Error("Token required");const i={endpoint:t.endpoint,keys:{p256dh:(r=t.keys)==null?void 0:r.p256dh,auth:(s=t.keys)==null?void 0:s.auth}};return this._request("/notifications/subscribe",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify(i)})}async unsubscribePush({authToken:e,endpoint:t}){if(!e)throw new Error("Token required");return this._request("/notifications/subscribe",{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({endpoint:t})})}}class j{constructor(e=window.localStorage){this.storage=e,this.storageKey="app_auth_token"}readToken(){return this.storage.getItem(this.storageKey)}saveToken(e){e&&this.storage.setItem(this.storageKey,e)}clearToken(){this.storage.removeItem(this.storageKey)}hasToken(){return!!this.readToken()}}class fe{constructor(e="BCCs2eonMI-6H2ctvFaWg-UYdDv387Vno_bzUzALpB442r2lCnsHmtrx8biyPi_E-1fSGABK_Qs_GlvPoJJqxbk"){this.vapidKey=e}async askPermission(){const e=await Notification.requestPermission();if(e!=="granted")throw new Error("Notification permission denied by user");return e}async getWorkerRegistration(){const e=await navigator.serviceWorker.getRegistration();if(!e)throw new Error("No service worker registration found");return e}_base64ToUint8Array(e){const t="=".repeat((4-e.length%4)%4),i=(e+t).replace(/-/g,"+").replace(/_/g,"/"),r=atob(i),s=new Uint8Array(r.length);for(let a=0;a<r.length;++a)s[a]=r.charCodeAt(a);return s}async ensureSubscription(e){const t=e||await this.getWorkerRegistration();let i=await t.pushManager.getSubscription();return i||(i=await t.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:this._base64ToUint8Array(this.vapidKey)})),i}async getActiveSubscription(){return(await this.getWorkerRegistration()).pushManager.getSubscription()}async removeSubscription(){const t=await(await this.getWorkerRegistration()).pushManager.getSubscription();if(!t)throw new Error("No active push subscription found");const i=t.endpoint;return await t.unsubscribe(),i}}const z=(n,e)=>e.some(t=>n instanceof t);let ee,te;function ye(){return ee||(ee=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function ve(){return te||(te=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const G=new WeakMap,W=new WeakMap,R=new WeakMap;function we(n){const e=new Promise((t,i)=>{const r=()=>{n.removeEventListener("success",s),n.removeEventListener("error",a)},s=()=>{t(L(n.result)),r()},a=()=>{i(n.error),r()};n.addEventListener("success",s),n.addEventListener("error",a)});return R.set(e,n),e}function be(n){if(G.has(n))return;const e=new Promise((t,i)=>{const r=()=>{n.removeEventListener("complete",s),n.removeEventListener("error",a),n.removeEventListener("abort",a)},s=()=>{t(),r()},a=()=>{i(n.error||new DOMException("AbortError","AbortError")),r()};n.addEventListener("complete",s),n.addEventListener("error",a),n.addEventListener("abort",a)});G.set(n,e)}let V={get(n,e,t){if(n instanceof IDBTransaction){if(e==="done")return G.get(n);if(e==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return L(n[e])},set(n,e,t){return n[e]=t,!0},has(n,e){return n instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in n}};function de(n){V=n(V)}function _e(n){return ve().includes(n)?function(...e){return n.apply(K(this),e),L(this.request)}:function(...e){return L(n.apply(K(this),e))}}function Se(n){return typeof n=="function"?_e(n):(n instanceof IDBTransaction&&be(n),z(n,ye())?new Proxy(n,V):n)}function L(n){if(n instanceof IDBRequest)return we(n);if(W.has(n))return W.get(n);const e=Se(n);return e!==n&&(W.set(n,e),R.set(e,n)),e}const K=n=>R.get(n);function Ie(n,e,{blocked:t,upgrade:i,blocking:r,terminated:s}={}){const a=indexedDB.open(n,e),u=L(a);return i&&a.addEventListener("upgradeneeded",c=>{i(L(a.result),c.oldVersion,c.newVersion,L(a.transaction),c)}),t&&a.addEventListener("blocked",c=>t(c.oldVersion,c.newVersion,c)),u.then(c=>{s&&c.addEventListener("close",()=>s()),r&&c.addEventListener("versionchange",o=>r(o.oldVersion,o.newVersion,o))}).catch(()=>{}),u}const Ee=["get","getKey","getAll","getAllKeys","count"],Le=["put","add","delete","clear"],q=new Map;function ne(n,e){if(!(n instanceof IDBDatabase&&!(e in n)&&typeof e=="string"))return;if(q.get(e))return q.get(e);const t=e.replace(/FromIndex$/,""),i=e!==t,r=Le.includes(t);if(!(t in(i?IDBIndex:IDBObjectStore).prototype)||!(r||Ee.includes(t)))return;const s=async function(a,...u){const c=this.transaction(a,r?"readwrite":"readonly");let o=c.store;return i&&(o=o.index(u.shift())),(await Promise.all([o[t](...u),r&&c.done]))[0]};return q.set(e,s),s}de(n=>({...n,get:(e,t,i)=>ne(e,t)||n.get(e,t,i),has:(e,t)=>!!ne(e,t)||n.has(e,t)}));const ke=["continue","continuePrimaryKey","advance"],ie={},J=new WeakMap,ue=new WeakMap,Te={get(n,e){if(!ke.includes(e))return n[e];let t=ie[e];return t||(t=ie[e]=function(...i){J.set(this,ue.get(this)[e](...i))}),t}};async function*Me(...n){let e=this;if(e instanceof IDBCursor||(e=await e.openCursor(...n)),!e)return;e=e;const t=new Proxy(e,Te);for(ue.set(t,e),R.set(t,K(e));e;)yield t,e=await(J.get(t)||e.continue()),J.delete(t)}function re(n,e){return e===Symbol.asyncIterator&&z(n,[IDBIndex,IDBObjectStore,IDBCursor])||e==="iterate"&&z(n,[IDBIndex,IDBObjectStore])}de(n=>({...n,get(e,t,i){return re(e,t)?Me:n.get(e,t,i)},has(e,t){return re(e,t)||n.has(e,t)}}));const{DATABASE_NAME:Pe,DATABASE_VERSION:Be,OBJECT_STORE_NAME:x}=le,$=Ie(Pe,Be,{upgrade(n){n.createObjectStore(x,{keyPath:"id"})}}),M={async getStory(n){return n?(await $).get(x,n):null},async getAllStories(){return(await $).getAll(x)},async putStory(n){if(n.hasOwnProperty("id"))return(await $).put(x,n)},async deleteStory(n){if(n)return(await $).delete(x,n)}};class xe{constructor(e){this.view=e,this._api=new O,this._auth=new j,this._notifier=new fe,this._current=1,this._limit=10}async loadStories(){this.view.showLoading();const e=this._auth.readToken();if(!e){this.view.showGuestView();return}this.view.showAuthenticatedView();try{const t=this.view.getLocationToggle()?1:0,i=await this._api.listStories({token:e,page:this._current,size:this._limit,location:t}),r=Array.isArray(i==null?void 0:i.listStory)?i.listStory:[];this.view.displayStories(r),this.view.renderPagination(this._current>1,r.length===this._limit),r.length>0&&(this.view.renderMap(r),r.forEach(s=>{M.putStory(s)}))}catch(t){console.error("Gagal mengambil data dari jaringan, mencoba dari cache...",t);const i=await M.getAllStories();i&&i.length>0?(this.view.displayStories(i),this.view.renderPagination(!1,!1),this.view.getLocationToggle()&&this.view.renderMap(i)):this.view.showError((t==null?void 0:t.message)||"Gagal memuat stories. Periksa koneksi internet Anda.")}}async onPageChange(e){e==="prev"&&this._current>1?this._current-=1:e==="next"&&(this._current+=1),await this.loadStories()}async onLocationToggle(){this._current=1,await this.loadStories()}async subscribeWebPush(){try{await this._notifier.askPermission();const e=await this._notifier.getWorkerRegistration(),t=await this._notifier.ensureSubscription(e),i=this._auth.readToken();if(!i)throw new Error("Login terlebih dahulu untuk berlangganan notifikasi");const r=t.toJSON?t.toJSON():t,s=await this._api.subscribePush({authToken:i,subscription:r});this.view.showMessage("Berhasil subscribe: "+((s==null?void 0:s.message)||"OK"))}catch(e){this.view.showMessage((e==null?void 0:e.message)||"Gagal subscribe")}}async unsubscribeWebPush(){try{const e=await this._notifier.removeSubscription(),t=this._auth.readToken();if(!t)throw new Error("Login diperlukan untuk berhenti berlangganan");const i=await this._api.unsubscribePush({authToken:t,endpoint:e});this.view.showMessage("Berhenti berlangganan: "+((i==null?void 0:i.message)||"OK"))}catch(e){this.view.showMessage((e==null?void 0:e.message)||"Gagal unsubscribe")}}}class Q{constructor(){this._map=null}ensureLeaflet(){if(typeof window>"u"||!window.L)throw new Error("Leaflet is not available in the current environment.");return window.L}create(e,t={}){const i=this.ensureLeaflet(),r={center:[-2.5,118],zoom:4.5,zoomControl:!0,...t};return this._map=i.map(e,r),this._map}addTiles(e,t={},i=!0){const r=this.ensureLeaflet(),s={maxZoom:19,attribution:"© OpenStreetMap contributors",...t},a=r.tileLayer(e,s);return i&&this._map&&a.addTo(this._map),a}placeMarker(e,t=null,i={}){const r=this.ensureLeaflet();if(!this._map)throw new Error("Map instance not created");const s=r.marker(e,i).addTo(this._map);return t&&s.bindPopup(t),s}createLayerGroup(e=!0){const i=this.ensureLeaflet().layerGroup();return e&&this._map&&i.addTo(this._map),i}addLayerSwitcher(e={},t={},i={}){const r=this.ensureLeaflet();if(!this._map)throw new Error("No map instance");const s={collapsed:!1,...i};return r.control.layers(e,t,s).addTo(this._map)}destroy(){this._map&&(this._map.remove(),this._map=null)}getInstance(){return this._map}}class Ae{constructor(){this.presenter=new xe(this),this.mapModel=new Q,this._mapId="stories-map-mvp",this._storiesListId="stories-list-mvp",this._paginationId="pagination-mvp",this._locationToggleId="location-toggle-mvp"}async render(){return`
      <section class="container">
        <div class="page-header" role="banner">
          <h1 id="page-title">Stories</h1>
          <p class="page-subtitle">Temukan dan bagikan cerita menarik dari komunitas</p>
        </div>

        <div class="toolbar">
          <label for="${this._locationToggleId}">
            <span class="sr-only">Toggle shown stories by location</span>
            <input id="${this._locationToggleId}" type="checkbox" /> Tampilkan lokasi
          </label>

          <div>
            <a href="#/add-story" class="btn">Add Story</a>
            <a id="home-login-btn" href="#/login" class="btn">Login</a>
            <a id="home-register-btn" href="#/register" class="btn">Register</a>
          </div>
        </div>

        <ul id="${this._storiesListId}" class="stories-grid" aria-live="polite"></ul>

        <nav id="${this._paginationId}" aria-label="Pagination"></nav>

        <div id="${this._mapId}" class="mini-map" style="height:360px;"></div>

        <div style="margin-top:20px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">
          <button id="push-subscribe" class="btn">Subscribe Push</button>
          <button id="push-unsubscribe" class="btn">Unsubscribe Push</button>
        </div>
      </section>
    `}showLoading(){const e=document.getElementById(this._storiesListId);e&&(e.innerHTML="<p>Loading...</p>")}showGuestView(){const e=document.querySelector(".main-content");e&&(e.innerHTML=`
      <div class="welcome-page">
        <div class="welcome-hero">
          <h1>Selamat Datang di Dicoding Story</h1>
          <p>Platform berbagi cerita terbaik untuk komunitas developer Indonesia</p>
          <div class="welcome-buttons">
            <a href="#/register" class="btn btn-primary">Daftar Sekarang</a>
            <a href="#/login" class="btn btn-outline">Masuk</a>
          </div>
        </div>
      </div>
    `)}showAuthenticatedView(){var e,t,i;(e=document.querySelector("#home-login-btn"))==null||e.setAttribute("aria-hidden","true"),(t=document.querySelector("#home-register-btn"))==null||t.setAttribute("aria-hidden","true"),(i=document.querySelector(".page-header"))==null||i.classList.remove("hidden")}displayStories(e){const t=document.getElementById(this._storiesListId);t&&(t.innerHTML=e.map(i=>`
      <li class="story-card">
        <a class="story-link" href="#/stories/${i.id}">
          <img src="${i.photoUrl}" alt="Foto oleh ${i.name}" loading="lazy" />
          <div class="story-content">
            <h3>${i.name}</h3>
            <p>${i.description}</p>
            <time style="font-size:12px;color:#666;" datetime="${i.createdAt}">${new Date(i.createdAt).toLocaleString("id-ID")}</time>
          </div>
        </a>
      </li>
    `).join(""))}renderPagination(e,t){const i=document.getElementById(this._paginationId);if(!i)return;i.innerHTML="";const r=(s,a,u)=>{const c=document.createElement("button");return c.textContent=s,c.disabled=!!a,c.addEventListener("click",u),c};i.appendChild(r("Prev",!e,()=>this.presenter.onPageChange("prev"))),i.appendChild(r("Next",!t,()=>this.presenter.onPageChange("next")))}renderMap(e=[]){const t=document.getElementById(this._mapId);if(!(!t||!window.L))try{this.mapModel.destroy(),t.innerHTML="";const i=this.mapModel.create(this._mapId,{center:[-2.5,118],zoom:4.5}),r=this.mapModel.addTiles("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:"© OpenStreetMap"}),s=this.mapModel.addTiles("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png",{subdomains:"abcd",maxZoom:20,attribution:"© CARTO"}),a=this.mapModel.addTiles("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",{maxZoom:17,attribution:"© OpenTopoMap"}),u=this.mapModel.createLayerGroup();e.filter(l=>typeof l.lat=="number"&&typeof l.lon=="number").forEach(l=>{this.mapModel.placeMarker([l.lat,l.lon],`<strong>${l.name}</strong><br/>${l.description}`)});const c={OSM:r,"Carto Light":s,Topo:a},o={Stories:u};this.mapModel.addLayerSwitcher(c,o)}catch(i){console.error("Map error:",i),t.innerHTML="<p>Error loading map. Please refresh.</p>"}}getLocationToggle(){var e;return!!((e=document.getElementById(this._locationToggleId))!=null&&e.checked)}showError(e){const t=document.getElementById(this._storiesListId);t&&(t.innerHTML=`<p role="alert">${e}</p>`)}showMessage(e){const t=document.createElement("div");t.textContent=e,t.style.position="fixed",t.style.right="16px",t.style.bottom="16px",t.style.padding="10px 14px",t.style.borderRadius="8px",t.style.background="var(--g-2, #6a8a52)",t.style.color="white",document.body.appendChild(t),setTimeout(()=>t.remove(),2200)}navigateToHome(){setTimeout(()=>window.location.hash="#/",800)}navigateToLogin(){setTimeout(()=>window.location.hash="#/login",800)}async afterRender(){const e=document.getElementById(this._locationToggleId),t=document.getElementById("push-subscribe"),i=document.getElementById("push-unsubscribe");e&&e.addEventListener("change",()=>this.presenter.onLocationToggle()),t&&t.addEventListener("click",()=>this.presenter.subscribeWebPush()),i&&i.addEventListener("click",()=>this.presenter.unsubscribeWebPush()),await this.presenter.loadStories()}}class he{constructor(e){this.view=e,this._api=new O,this._auth=new j}async login(e){var t;try{this.view.showLoading("Memproses login...");const i=await this._api.signIn({email:e.email,password:e.password}),r=(t=i==null?void 0:i.loginResult)==null?void 0:t.token;if(!r)throw new Error("Terima respons tanpa token dari server");this._auth.saveToken(r),this.view.showSuccess("Login berhasil. Mengarahkan ke halaman utama..."),this.view.navigateToHome()}catch(i){const r=(i==null?void 0:i.message)||"Gagal login";this.view.showError(r)}}async register(e){try{this.view.showLoading("Mendaftarkan akun..."),await this._api.signUp({name:e.name,email:e.email,password:e.password}),this.view.showSuccess("Registrasi berhasil. Silakan login."),this.view.navigateToLogin()}catch(t){const i=(t==null?void 0:t.message)||"Gagal registrasi";this.view.showError(i)}}logout(){this._auth.clearToken(),this.view.navigateToLogin()}}class Ce{constructor(){this.presenter=new he(this),this._formId="form-login",this._statusId="status-login"}async render(){return`
      <div class="auth-page" data-view="signin">
        <div class="auth-container">
          <div class="auth-card" role="region" aria-labelledby="signin-title">
            <h1 id="signin-title" class="auth-title">Sign in</h1>

            <form id="${this._formId}" class="auth-form" novalidate aria-describedby="${this._statusId}">
              <div class="form-group">
                <label for="signin-email">Email</label>
                <input id="signin-email" name="email" type="email" inputmode="email" required autocomplete="email" />
              </div>

              <div class="form-group">
                <label for="signin-pass">Password</label>
                <input id="signin-pass" name="password" type="password" minlength="8" required autocomplete="current-password" />
              </div>

              <div class="form-actions" style="display:flex; gap:12px; align-items:center;">
                <button class="btn btn-primary" type="submit" aria-label="Sign in">Sign in</button>
                <a class="btn btn-outline" href="#/forgot">Forgot?</a>
              </div>
            </form>

            <p class="auth-link" style="margin-top:12px;">Belum punya akun? <a href="#/register">Daftar</a></p>

            <div id="${this._statusId}" role="status" aria-live="polite" class="auth-message" style="min-height:1.25rem; margin-top:10px;"></div>
          </div>
        </div>
      </div>
    `}showLoading(e="Processing..."){const t=document.getElementById(this._statusId);t&&(t.textContent=String(e))}showSuccess(e="Logged in"){const t=document.getElementById(this._statusId);t&&(t.textContent=String(e),t.classList.remove("error"),t.classList.add("success"))}showError(e="Failed to login"){const t=document.getElementById(this._statusId);t&&(t.textContent=String(e),t.classList.remove("success"),t.classList.add("error"))}navigateToHome(){setTimeout(()=>{window.location.hash="#/"},900)}async afterRender(){const e=document.getElementById(this._formId);e&&e.addEventListener("submit",async t=>{t.preventDefault();const i=new FormData(e),r={email:(i.get("email")||"").toString().trim(),password:(i.get("password")||"").toString()};if(!r.email){this.showError("Email harus diisi");return}if(!r.password||r.password.length<8){this.showError("Password minimal 8 karakter");return}try{this.showLoading("Logging in..."),await this.presenter.login({email:r.email,password:r.password})}catch(s){this.showError((s==null?void 0:s.message)||"Terjadi kesalahan")}})}}class $e{constructor(){this.presenter=new he(this),this._formId="form-register",this._statusId="status-register"}async render(){return`
      <div class="auth-page" data-view="signup">
        <div class="auth-container">
          <div class="auth-card" role="region" aria-labelledby="signup-title">
            <h1 id="signup-title" class="auth-title">Create account</h1>

            <form id="${this._formId}" class="auth-form" novalidate aria-describedby="${this._statusId}">
              <div class="form-group">
                <label for="reg-name">Nama lengkap</label>
                <input id="reg-name" name="name" type="text" required autocomplete="name" />
              </div>

              <div class="form-group">
                <label for="reg-email">Email</label>
                <input id="reg-email" name="email" type="email" required autocomplete="email" />
              </div>

              <div class="form-group">
                <label for="reg-pass">Password</label>
                <input id="reg-pass" name="password" type="password" minlength="8" required autocomplete="new-password" />
              </div>

              <div class="form-actions">
                <button class="btn btn-primary" type="submit">Daftar</button>
              </div>
            </form>

            <p class="auth-link" style="margin-top:12px;">Sudah punya akun? <a href="#/login">Masuk</a></p>

            <div id="${this._statusId}" role="status" aria-live="polite" class="auth-message" style="min-height:1.25rem; margin-top:10px;"></div>
          </div>
        </div>
      </div>
    `}showLoading(e="Processing..."){const t=document.getElementById(this._statusId);t&&(t.textContent=String(e))}showSuccess(e="Registration successful"){const t=document.getElementById(this._statusId);t&&(t.textContent=String(e),t.classList.remove("error"),t.classList.add("success"))}showError(e="Registration failed"){const t=document.getElementById(this._statusId);t&&(t.textContent=String(e),t.classList.remove("success"),t.classList.add("error"))}navigateToLogin(){setTimeout(()=>{window.location.hash="#/login"},900)}async afterRender(){const e=document.getElementById(this._formId);e&&e.addEventListener("submit",async t=>{t.preventDefault();const i=new FormData(e),r={name:(i.get("name")||"").toString().trim(),email:(i.get("email")||"").toString().trim(),password:(i.get("password")||"").toString()};if(!r.name){this.showError("Nama harus diisi");return}if(!r.email){this.showError("Email harus diisi");return}if(!r.password||r.password.length<8){this.showError("Password minimal 8 karakter");return}try{this.showLoading("Mendaftarkan akun..."),await this.presenter.register({name:r.name,email:r.email,password:r.password})}catch(s){this.showError((s==null?void 0:s.message)||"Terjadi kesalahan saat mendaftar")}})}}function pe(){const n=(location.hash||"").replace(/^#/,"").trim();return n===""?"/":n}function me(n){const e=n.replace(/\/+$/,"").replace(/^\/+/,"");if(!e)return{resource:null,id:null};const t=e.split("/");return{resource:t[0]||null,id:t[1]||null}}function De({resource:n,id:e}){return n?e?`/${n}/:id`:`/${n}`:"/"}function Oe(){const n=pe(),e=me(n);return De(e)}function je(){const n=pe();return me(n)}class Re{constructor(){this._api=new O,this._auth=new j,this.mapModel=new Q,this._story=null}async render(){return`
      <div class="container">
        <div id="story-detail-container" class="story-detail-container">
          <p class="loading-text">Memuat cerita...</p>
        </div>
      </div>
    `}async afterRender(){const t=je().id,i=document.getElementById("story-detail-container"),r=this._auth.readToken();if(!r){i.innerHTML='<p class="error-message">Anda harus login untuk melihat detail cerita.</p>';return}try{const s=await this._api.getStoryDetail({token:r,id:t});if(s.error)throw new Error(s.message);this._story=s.story,this._renderStoryDetail(i,this._story),this._story.lat&&this._story.lon&&this._renderMap(this._story.lat,this._story.lon),await this._addSaveButton(this._story)}catch(s){i.innerHTML=`<p class="error-message">Gagal memuat cerita: ${s.message}</p>`}}_renderStoryDetail(e,t){e.innerHTML=`
      <h1 class="story-title">${t.name}</h1>
      <img src="${t.photoUrl}" alt="${t.description}" class="story-photo">
      <div class="story-meta">
        <p class="story-author">Oleh: ${t.name}</p>
        <p class="story-date">${new Date(t.createdAt).toLocaleString("id-ID")}</p>
      </div>
      <p class="story-description">${t.description}</p>
      
      <div id="detail-map" class="detail-map"></div>
      <div id="save-button-container" class="save-button-container"></div>
    `,(!t.lat||!t.lon)&&(document.getElementById("detail-map").style.display="none")}_renderMap(e,t){if(window.L)try{const i=this.mapModel.create("detail-map",{center:[e,t],zoom:15});this.mapModel.addTiles("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"),this.mapModel.placeMarker([e,t])}catch(i){console.error("Gagal memuat peta detail",i)}}async _addSaveButton(e){const t=document.getElementById("save-button-container");if(!t){console.error("Elemen #save-button-container tidak ditemukan!");return}if(await M.getStory(e.id))t.innerHTML='<button class="btn" disabled>Tersimpan Offline</button>';else{const r=document.createElement("button");r.className="btn btn-primary",r.innerText="Simpan untuk Offline",r.addEventListener("click",async()=>{await M.putStory(e),alert("Cerita berhasil disimpan!"),this._addSaveButton(e)}),t.innerHTML="",t.appendChild(r)}}}class Ue{constructor(e){this.view=e,this._storyService=new O,this._authStore=new j}async addStory(e){try{this.view.showLoading("Mengirim story...");const t=this._authStore.readToken();if(!t)throw se("Silakan login terlebih dahulu untuk menambahkan story",401);if(e!=null&&e.photoFile&&!(e.photoFile instanceof File))throw se("File foto tidak valid.",400);const i={authToken:t,text:e.description,file:e.photoFile,lat:e.lat,lon:e.lon};await this._storyService.createStory(i),this.view.showSuccess("Story berhasil dikirim 🎉"),this.view.navigateToHome()}catch(t){const i=t&&t.message?t.message:"Gagal mengirim story";this.view.showError(i)}}}function se(n,e=500){const t=new Error(n);return t.status=e,t}class Fe{constructor(){this.presenter=new Ue(this),this.mapModel=new Q,this._formId="addstory-form-v2",this._latId="input-lat-v2",this._lonId="input-lon-v2",this._miniMapId="mini-map-v2",this._statusId="addstory-status-v2",this._videoId="camera-video-v2",this._canvasId="camera-canvas-v2",this._photoId="photo-preview-v2",this._openBtnId="open-camera-v2",this._captureBtnId="capture-photo-v2",this._closeBtnId="close-camera-v2",this._fileUploadId="file-upload-v2"}async render(){return`
      <div class="add-story-page" data-view="add-v2">
        <div class="add-story-container">
          <div class="add-story-card">
            <h1 class="add-story-title">Tambah Cerita</h1>
            <form id="${this._formId}" class="add-story-form" enctype="multipart/form-data" novalidate>
              <div class="form-group">
                <label for="desc-v2">Deskripsi</label>
                <textarea id="desc-v2" name="description" required placeholder="Ceritakan momen coding Anda..."></textarea>
              </div>

              <section class="camera-section" aria-labelledby="camera-label-v2">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                  <h3 id="camera-label-v2" class="camera-label">Foto (opsional)</h3>
                  <small class="map-instruction">Bisa ambil dari kamera atau upload</small>
                </div>

                <!-- File Upload Input -->
                <div class="file-upload-section" style="margin:8px 0;">
                  <label for="file-upload-v2" class="btn btn-outline" style="display:inline-block; cursor:pointer;">
                    📁 Upload File
                    <input id="file-upload-v2" type="file" accept="image/*" style="display:none;" />
                  </label>
                </div>

                <div class="camera-controls" style="margin:8px 0;">
                  <button id="${this._openBtnId}" type="button" class="btn btn-outline">📷 Buka Kamera</button>
                  <button id="${this._captureBtnId}" type="button" class="btn btn-primary" disabled>Ambil</button>
                  <button id="${this._closeBtnId}" type="button" class="btn btn-outline" disabled>Tutup</button>
                </div>

                <video id="${this._videoId}" playsinline class="camera-preview" style="display:none;"></video>
                <canvas id="${this._canvasId}" class="camera-canvas" style="display:none;"></canvas>
                <img id="${this._photoId}" alt="Preview foto" class="photo-preview" style="display:none; margin-top:8px; max-width:100%; border-radius:8px;"/>
              </section>

              <section class="location-section" aria-labelledby="loc-label-v2">
                <h3 id="loc-label-v2" class="location-label">Lokasi (opsional)</h3>
                <div class="location-inputs" style="margin-bottom:8px;">
                  <div class="form-group">
                    <label for="${this._latId}">Latitude</label>
                    <input id="${this._latId}" name="lat" type="number" step="any" placeholder="Contoh: -6.200000" />
                  </div>
                  <div class="form-group">
                    <label for="${this._lonId}">Longitude</label>
                    <input id="${this._lonId}" name="lon" type="number" step="any" placeholder="Contoh: 106.816666" />
                  </div>
                </div>
                <p class="map-instruction">Klik peta di bawah untuk mengisi koordinat</p>
                <div id="${this._miniMapId}" class="mini-map" style="margin-top:8px;"></div>
              </section>

              <div style="margin-top:14px;">
                <button class="btn btn-primary submit-btn" type="submit">Kirim Cerita</button>
              </div>
            </form>

            <div id="${this._statusId}" role="status" class="add-story-message" style="margin-top:12px; min-height:1.25rem;"></div>
          </div>
        </div>
      </div>
    `}showLoading(e="Mengirim..."){const t=document.getElementById(this._statusId);t&&(t.textContent=e)}showSuccess(e="Berhasil!"){const t=document.getElementById(this._statusId);t&&(t.textContent=e,t.classList.remove("error"),t.classList.add("success"))}showError(e="Gagal"){const t=document.getElementById(this._statusId);t&&(t.textContent=e,t.classList.remove("success"),t.classList.add("error"))}navigateToHome(){setTimeout(()=>window.location.hash="#/",800)}async afterRender(){const e=document.getElementById(this._formId),t=document.getElementById(this._latId),i=document.getElementById(this._lonId),r=document.getElementById(this._openBtnId),s=document.getElementById(this._captureBtnId),a=document.getElementById(this._closeBtnId),u=document.getElementById(this._fileUploadId),c=document.getElementById(this._videoId),o=document.getElementById(this._canvasId),l=document.getElementById(this._photoId),h=document.getElementById(this._miniMapId);let d=null,m=null,g=null;const w=()=>{d&&(d.getTracks().forEach(p=>p.stop()),d=null),c&&(c.style.display="none"),s.disabled=!0,a.disabled=!0};if(r==null||r.addEventListener("click",async()=>{try{d=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}),c.srcObject=d,await c.play(),c.style.display="block",s.disabled=!1,a.disabled=!1}catch(p){this.showError("Gagal membuka kamera: "+((p==null?void 0:p.message)||p))}}),s==null||s.addEventListener("click",async()=>{try{const p=c.videoWidth,f=c.videoHeight;o.width=p,o.height=f,o.getContext("2d").drawImage(c,0,0,p,f),await new Promise(S=>{o.toBlob(E=>{if(!E)return S();m=new File([E],`capture-${Date.now()}.jpg`,{type:E.type||"image/jpeg"}),l.src=URL.createObjectURL(E),l.style.display="block",S()},"image/jpeg",.9)})}catch{this.showError("Gagal mengambil foto")}finally{w()}}),a==null||a.addEventListener("click",()=>w()),window.addEventListener("hashchange",w,{once:!0}),u==null||u.addEventListener("change",p=>{const f=p.target.files[0];if(f){m=f;const b=URL.createObjectURL(f);l.src=b,l.style.display="block",w()}}),window.L&&h)try{const p=this.mapModel.create(this._miniMapId,{center:[-2.5,118],zoom:4.5});this.mapModel.addTiles("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:"© OpenStreetMap"}),p.on("click",f=>{const{lat:b,lng:S}=f.latlng;t.value=b.toFixed(6),i.value=S.toFixed(6),g?g.setLatLng([b,S]):g=this.mapModel.placeMarker([b,S])})}catch(p){console.error("Mini-map error",p)}e==null||e.addEventListener("submit",async p=>{var E;p.preventDefault();const f=(E=e.description.value)==null?void 0:E.trim(),b=t.value?parseFloat(t.value):void 0,S=i.value?parseFloat(i.value):void 0;if(!f){this.showError("Deskripsi wajib diisi");return}try{this.showLoading("Mengirim cerita..."),await this.presenter.addStory({description:f,photoFile:m,lat:b,lon:S})}catch(U){this.showError((U==null?void 0:U.message)||"Terjadi kesalahan saat mengirim")}})}}class We{async render(){return`
      <div class="container">
        <h1 class="page-title">Cerita Tersimpan</h1>
        <ul id="saved-stories-list" class="stories-grid"></ul>
      </div>
    `}async afterRender(){const e=document.getElementById("saved-stories-list");e.innerHTML="<p>Memuat cerita tersimpan...</p>";const t=await M.getAllStories();t.length>0?(e.innerHTML="",t.forEach(i=>{e.innerHTML+=this._createStoryItemTemplate(i)}),e.querySelectorAll(".btn-delete-story").forEach(i=>{i.addEventListener("click",async r=>{const s=r.target.dataset.id;await M.deleteStory(s),alert("Cerita berhasil dihapus!"),this.afterRender()})})):e.innerHTML="<p>Belum ada cerita yang disimpan.</p>"}_createStoryItemTemplate(e){return`
      <li class="story-card">
        <a class="story-link" href="#/stories/${e.id}">
          <img src="${e.photoUrl}" alt="${e.name}" loading="lazy" />
          <div class="story-content"><h3>${e.name}</h3><p>${e.description}</p></div>
        </a>
        <button class="btn btn-danger btn-delete-story" data-id="${e.id}">Hapus</button>
      </li>
    `}}const k={home:new Ae,login:new Ce,register:new $e,storyDetail:new Re,addStory:new Fe},qe={"/":k.home,"/login":k.login,"/register":k.register,"/stories":k.home,"/stories/:id":k.storyDetail,"/add-story":k.addStory,"/saved":We};var A,T,v,D,ge;class Ne{constructor({navigationDrawer:e,drawerButton:t,content:i}){P(this,D);P(this,A);P(this,T);P(this,v);C(this,v,e),C(this,T,t),C(this,A,i),X(this,D,ge).call(this)}async displayPage(){const e=Oe(),t=qe[e],i=async()=>{y(this,A).innerHTML=await t.render(),await t.afterRender()};document.startViewTransition?await document.startViewTransition(i).finished:await i()}}A=new WeakMap,T=new WeakMap,v=new WeakMap,D=new WeakSet,ge=function(){y(this,T).addEventListener("click",()=>{y(this,v).classList.toggle("open")}),document.body.addEventListener("click",e=>{const t=e.target;!y(this,v).contains(t)&&!y(this,T).contains(t)&&y(this,v).classList.remove("open"),y(this,v).querySelectorAll("a").forEach(i=>{i.contains(t)&&y(this,v).classList.remove("open")})})};try{self["workbox:window:7.2.0"]&&_()}catch{}function ae(n,e){return new Promise(function(t){var i=new MessageChannel;i.port1.onmessage=function(r){t(r.data)},n.postMessage(e,[i.port2])})}function He(n){var e=function(t,i){if(typeof t!="object"||!t)return t;var r=t[Symbol.toPrimitive];if(r!==void 0){var s=r.call(t,i);if(typeof s!="object")return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(n,"string");return typeof e=="symbol"?e:e+""}function ze(n,e){for(var t=0;t<e.length;t++){var i=e[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(n,He(i.key),i)}}function Z(n,e){return Z=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,i){return t.__proto__=i,t},Z(n,e)}function oe(n,e){(e==null||e>n.length)&&(e=n.length);for(var t=0,i=new Array(e);t<e;t++)i[t]=n[t];return i}function Ge(n,e){var t=typeof Symbol<"u"&&n[Symbol.iterator]||n["@@iterator"];if(t)return(t=t.call(n)).next.bind(t);if(Array.isArray(n)||(t=function(r,s){if(r){if(typeof r=="string")return oe(r,s);var a=Object.prototype.toString.call(r).slice(8,-1);return a==="Object"&&r.constructor&&(a=r.constructor.name),a==="Map"||a==="Set"?Array.from(r):a==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?oe(r,s):void 0}}(n))||e){t&&(n=t);var i=0;return function(){return i>=n.length?{done:!0}:{done:!1,value:n[i++]}}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}try{self["workbox:core:7.2.0"]&&_()}catch{}var N=function(){var n=this;this.promise=new Promise(function(e,t){n.resolve=e,n.reject=t})};function H(n,e){var t=location.href;return new URL(n,t).href===new URL(e,t).href}var B=function(n,e){this.type=n,Object.assign(this,e)};function I(n,e,t){return t?e?e(n):n:(n&&n.then||(n=Promise.resolve(n)),e?n.then(e):n)}function Ve(){}var Ke={type:"SKIP_WAITING"};function ce(n,e){return n&&n.then?n.then(Ve):Promise.resolve()}var Je=function(n){function e(u,c){var o,l;return c===void 0&&(c={}),(o=n.call(this)||this).nn={},o.tn=0,o.rn=new N,o.en=new N,o.on=new N,o.un=0,o.an=new Set,o.cn=function(){var h=o.fn,d=h.installing;o.tn>0||!H(d.scriptURL,o.sn.toString())||performance.now()>o.un+6e4?(o.vn=d,h.removeEventListener("updatefound",o.cn)):(o.hn=d,o.an.add(d),o.rn.resolve(d)),++o.tn,d.addEventListener("statechange",o.ln)},o.ln=function(h){var d=o.fn,m=h.target,g=m.state,w=m===o.vn,p={sw:m,isExternal:w,originalEvent:h};!w&&o.mn&&(p.isUpdate=!0),o.dispatchEvent(new B(g,p)),g==="installed"?o.wn=self.setTimeout(function(){g==="installed"&&d.waiting===m&&o.dispatchEvent(new B("waiting",p))},200):g==="activating"&&(clearTimeout(o.wn),w||o.en.resolve(m))},o.yn=function(h){var d=o.hn,m=d!==navigator.serviceWorker.controller;o.dispatchEvent(new B("controlling",{isExternal:m,originalEvent:h,sw:d,isUpdate:o.mn})),m||o.on.resolve(d)},o.gn=(l=function(h){var d=h.data,m=h.ports,g=h.source;return I(o.getSW(),function(){o.an.has(g)&&o.dispatchEvent(new B("message",{data:d,originalEvent:h,ports:m,sw:g}))})},function(){for(var h=[],d=0;d<arguments.length;d++)h[d]=arguments[d];try{return Promise.resolve(l.apply(this,h))}catch(m){return Promise.reject(m)}}),o.sn=u,o.nn=c,navigator.serviceWorker.addEventListener("message",o.gn),o}var t,i;i=n,(t=e).prototype=Object.create(i.prototype),t.prototype.constructor=t,Z(t,i);var r,s,a=e.prototype;return a.register=function(u){var c=(u===void 0?{}:u).immediate,o=c!==void 0&&c;try{var l=this;return I(function(h,d){var m=h();return m&&m.then?m.then(d):d(m)}(function(){if(!o&&document.readyState!=="complete")return ce(new Promise(function(h){return window.addEventListener("load",h)}))},function(){return l.mn=!!navigator.serviceWorker.controller,l.dn=l.pn(),I(l.bn(),function(h){l.fn=h,l.dn&&(l.hn=l.dn,l.en.resolve(l.dn),l.on.resolve(l.dn),l.dn.addEventListener("statechange",l.ln,{once:!0}));var d=l.fn.waiting;return d&&H(d.scriptURL,l.sn.toString())&&(l.hn=d,Promise.resolve().then(function(){l.dispatchEvent(new B("waiting",{sw:d,wasWaitingBeforeRegister:!0}))}).then(function(){})),l.hn&&(l.rn.resolve(l.hn),l.an.add(l.hn)),l.fn.addEventListener("updatefound",l.cn),navigator.serviceWorker.addEventListener("controllerchange",l.yn),l.fn})}))}catch(h){return Promise.reject(h)}},a.update=function(){try{return this.fn?I(ce(this.fn.update())):I()}catch(u){return Promise.reject(u)}},a.getSW=function(){return this.hn!==void 0?Promise.resolve(this.hn):this.rn.promise},a.messageSW=function(u){try{return I(this.getSW(),function(c){return ae(c,u)})}catch(c){return Promise.reject(c)}},a.messageSkipWaiting=function(){this.fn&&this.fn.waiting&&ae(this.fn.waiting,Ke)},a.pn=function(){var u=navigator.serviceWorker.controller;return u&&H(u.scriptURL,this.sn.toString())?u:void 0},a.bn=function(){try{var u=this;return I(function(c,o){try{var l=c()}catch(h){return o(h)}return l&&l.then?l.then(void 0,o):l}(function(){return I(navigator.serviceWorker.register(u.sn,u.nn),function(c){return u.un=performance.now(),c})},function(c){throw c}))}catch(c){return Promise.reject(c)}},r=e,(s=[{key:"active",get:function(){return this.en.promise}},{key:"controlling",get:function(){return this.on.promise}}])&&ze(r.prototype,s),Object.defineProperty(r,"prototype",{writable:!1}),r}(function(){function n(){this.Pn=new Map}var e=n.prototype;return e.addEventListener=function(t,i){this.jn(t).add(i)},e.removeEventListener=function(t,i){this.jn(t).delete(i)},e.dispatchEvent=function(t){t.target=this;for(var i,r=Ge(this.jn(t.type));!(i=r()).done;)(0,i.value)(t)},e.jn=function(t){return this.Pn.has(t)||this.Pn.set(t,new Set),this.Pn.get(t)},n}());(async function(){document.readyState==="loading"&&await new Promise(a=>document.addEventListener("DOMContentLoaded",a,{once:!0}));const e=document.querySelector("#app-main"),t=document.querySelector("#menu-toggle"),i=document.querySelector("#side-navigation");if(!e){console.error("Main content element not found");return}const r=new Ne({content:e,drawerButton:t,navigationDrawer:i});async function s(){try{if(typeof r.displayPage=="function"){await r.displayPage();return}if(typeof r.renderPage=="function"){await r.renderPage();return}console.warn("No render method found on app instance")}catch(a){console.error("Error rendering page:",a)}}if(await s(),window.addEventListener("hashchange",async()=>{try{await s()}catch(a){console.error("Failed to render page on hashchange",a)}}),"serviceWorker"in navigator){const a=new Je("/sw.js");try{await a.register(),console.log("Service worker registered successfully")}catch(u){console.error("Service worker registration failed:",u)}}})();
